const images = [
  //Seal 1
  {
    name: "correcto1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/1/correcto.png",
  },
  {
    name: "incorrecto1-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/1/incorrecto-1.png",
  },
  {
    name: "incorrecto1-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/1/incorrecto-2.png",
  },
  {
    name: "incorrecto1-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/1/incorrecto-3.png",
  },
  //Seal 2
  {
    name: "correcto2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/2/correcto.png",
  },
  {
    name: "incorrecto2-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/2/incorrecto-1.png",
  },
  {
    name: "incorrecto2-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/2/incorrecto-2.png",
  },
  {
    name: "incorrecto2-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/2/incorrecto-3.png",
  },
  //Seal 3
  {
    name: "correcto3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/3/correcto.png",
  },
  {
    name: "incorrecto3-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/3/incorrecto-1.png",
  },
  {
    name: "incorrecto3-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/3/incorrecto-2.png",
  },
  {
    name: "incorrecto3-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/3/incorrecto-3.png",
  },
  //Seal 4
  {
    name: "correcto4",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/4/correcto.png",
  },
  {
    name: "incorrecto4-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/4/incorrecto-1.png",
  },
  {
    name: "incorrecto4-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/4/incorrecto-2.png",
  },
  {
    name: "incorrecto4-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/4/incorrecto-3.png",
  },
  //Seal 5
  {
    name: "correcto5",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/5/correcto.png",
  },
  {
    name: "incorrecto5-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/5/incorrecto-1.png",
  },
  {
    name: "incorrecto5-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/5/incorrecto-2.png",
  },
  {
    name: "incorrecto5-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/5/incorrecto-3.png",
  },
  //Seal 6
  {
    name: "correcto6",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/6/correcto.png",
  },
  {
    name: "incorrecto6-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/6/incorrecto-1.png",
  },
  {
    name: "incorrecto6-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/6/incorrecto-2.png",
  },
  {
    name: "incorrecto6-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/6/incorrecto-3.png",
  },
];
const sprites = [
  {
    name: "halloweenChallenge",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/spritesheets/challenge-communication.json",
  },
  {
    name: "halloweenTime",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/spritesheets/timer_v2.json",
  },
  {
    name: "halloweenReminder",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/spritesheets/reminderHalloween.json",
  },
  {
    name: "halloweenCementery",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/spritesheets/cementery-illustration.json",
  },
  {
    name: "newChallengeSuccess",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/spritesheets/win_challenge.json",
  },
  {
    name: "newChallengeFail",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/spritesheets/lose_challenge.json",
  },
  {
    name: "newChallengeSuccessSpanish",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/spritesheets/win_challenge_es.json",
  },
  {
    name: "newChallengeFailSpanish",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/spritesheets/lose_challenge_es.json",
  },
  {
    name: "ghostReminder",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/spritesheets/phasmoReminder.json",
  },
  {
    name: "newTime",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/spritesheets/phasmoTimer.json",
  },
];
const sounds = [
  "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/sounds/youWinSFX.mp3",
  "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/phasmophobia/assets/sounds/youLoseSFX.mp3",
];

let reminder,
  timer,
  onClickSub,
  ghost,
  randomOrderGhost,
  selectedGhost,
  ghostName,
  evidencesGhost,
  randomEvidence,
  correctEvidence,
  correctAnswer,
  evidenceWrongAnswer,
  answers,
  randomAnswers;

let symbol;
let baseURL =
  "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/";
let sealsNum = [1, 2, 3, 4, 5, 6];
let initialIdx, lastIdx;
let playedTimes = 1;
let optionWidth;
let assetFail, assetSuccess;
let titleChallengePanel, acceptButton, declineButton, halloweenPanel;

let orderedAnswers = [];
let unorderedAnswers = [];
let buttonArray = [];
let timeoutArray = [];

let controllerButtonArray = ["FACE_1", "FACE_2", "FACE_3", "FACE_4"];

// INPUTS PARAMS

const {
  challengeTitle,
  challengeTime,
  reminderTitle,
  acceptButtonText,
  declineButtonText,
  textCountdown,
  questionsNum,
} = DX_INPUTS;

const optionsList = [
  {
    option: "phasmoReminder.png",
  },
];

//#region Dixper functions

// DIXPER SDK INJECTED CLASS

const dixperPluginSample = new DixperSDKLib({
  pixi: {
    enable: true,
    files: [...images, ...sprites, ...sounds],
  },
});

// PIXIJS INITILIZE

dixperPluginSample.onPixiLoad = () => {
  if (DX_CONTEXT.language === "es") {
    assetFail = "newChallengeFailSpanish";
    assetSuccess = "newChallengeSuccessSpanish";
  } else {
    assetFail = "newChallengeFail";
    assetSuccess = "newChallengeSuccess";
  }

  createChallenge();
};

//Clean timeouts

const clearTimeouts = () => {
  console.log(timeoutArray.length);
  timeoutArray.forEach((element) => {
    clearTimeout(element);
    console.log("timeout id: " + element + " cleared");
  });
  dixperPluginSample.stopSkill();
};

//#endregion

//#region Challenge functions

// INIT CHALLENGE

dixperPluginSample.initCountdown = () => {
  const countDown = new dxCountDown(
    DX_PIXI,
    "countDown",
    DX_LAYERS.ui,
    3,
    textCountdown,
    {
      position: {
        x: DX_WIDTH / 2,
        y: DX_HEIGHT / 2,
      },
      scale: {
        x: 0.25,
        y: 0.25,
      },
      animationSpeed: 0.5,
    }
  );

  countDown.onOutFinish = () => {
    onChallengeAccepted();
  };
};

dixperPluginSample.onChallengeRejected = () => {
  dixperPluginSample.stopSkill();
};

dixperPluginSample.onChallengeFinish = () => {};

const createChallenge = () => {
  titleChallengePanel = new dxPanel(
    DX_PIXI,
    "halloweenChallenge",
    DX_LAYERS.ui,
    challengeTitle,
    {
      position: {
        x: DX_WIDTH / 2,
        y: 250,
      },
      scale: {
        x: 0.8,
        y: 0.8,
      },
      animationSpeed: 0.5,
      text: {
        fontSize: 20,
        lineHeight: 23,
        strokeThickness: 0,
        dropShadowDistance: 0,
      },
    }
  );

  acceptButton = new DxButton(
    "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/halloween/assets/images/accept_challenge-button.png",
    acceptButtonText,
    {
      isClickable: true,
      controller: {
        isPressable: true,
        button: "FACE_1",
        x: 0,
        y: 50,
      },
      keyboard: {
        isPressable: true,
        button: "Enter",
        x: 0,
        y: 50,
      },
      position: {
        x: DX_WIDTH / 2 - 150,
        y: 450,
      },
      scale: {
        x: 1,
        y: 1,
      },
      text: {
        fontSize: 20,
        lineHeight: 23,
        strokeThickness: 0,
        dropShadowDistance: 0,
      },
    }
  );

  declineButton = new DxButton(
    "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/main/src/halloween/assets/images/decline-challenge-button.png",
    declineButtonText,
    {
      isClickable: true,
      controller: {
        isPressable: true,
        button: "FACE_2",
        x: 0,
        y: 50,
      },
      keyboard: {
        isPressable: true,
        button: "Esc",
        x: 0,
        y: 50,
      },
      position: {
        x: DX_WIDTH / 2 + 150,
        y: 450,
      },
      scale: {
        x: 1,
        y: 1,
      },
      text: {
        fontSize: 20,
        lineHeight: 23,
        strokeThickness: 0,
        dropShadowDistance: 0,
      },
    }
  );

  halloweenPanel = new dxPanel(
    DX_PIXI,
    "halloweenCementery",
    DX_LAYERS.ui,
    "",
    {
      position: {
        x: DX_WIDTH / 2,
        y: DX_HEIGHT - 195,
      },
      scale: {
        x: 1,
        y: 1,
      },
      animationSpeed: 0.5,
      zIndex: 99,
    }
  );

  acceptButton.start();
  declineButton.start();

  acceptButton.onClick = (event) => {
    removeChallenge();
    dixperPluginSample.initCountdown();
  };
  declineButton.onClick = (event) => {
    dixperPluginSample.onChallengeRejected();
  };
};

const onChallengeAccepted = () => {
  reminder = new dxPanel(
    DX_PIXI,
    "halloweenReminder",
    DX_LAYERS.ui,
    reminderTitle,
    {
      position: {
        x: 250,
        y: 300,
      },
      scale: {
        x: 0.8,
        y: 0.8,
      },
      animationSpeed: 0.5,
      text: {
        fontSize: 20,
        lineHeight: 20,
        strokeThickness: 0,
        dropShadowDistance: 0,
      },
    }
  );
  const interval = 1000;

  timer = new dxTimer(
    DX_PIXI,
    "halloweenTime",
    DX_LAYERS.ui,
    challengeTime,
    interval,
    {
      position: {
        x: reminder._options.position.x,
        y: reminder._options.position.y + 75 * reminder._options.scale.y,
      },
      scale: {
        x: reminder._options.scale.x / 2,
        y: reminder._options.scale.y / 2,
      },
      animationSpeed: 0.5,
    }
  );
  timer.onTimerFinish = () => {
    dixperPluginSample.stopSkill();
    console.log("fin skill");
  };
  init();
};

const removeChallenge = () => {
  titleChallengePanel._destroy();
  acceptButton.remove();
  declineButton.remove();
  halloweenPanel._destroy();
};

const createChallengeSuccess = () => {
  const challengeSuccessSFX = PIXI.sound.Sound.from(sounds[0]);
  challengeSuccessSFX.play({ volume: 0.75 });

  const panelChallengeSuccess = new dxPanel(
    DX_PIXI,
    assetSuccess,
    DX_LAYERS.ui,
    "",
    {
      position: {
        x: DX_WIDTH / 2,
        y: DX_HEIGHT / 2,
      },
      scale: {
        x: 1,
        y: 1,
      },
      animationSpeed: 0.5,
    }
  );
  let temp = setTimeout(() => panelChallengeSuccess.remove(), 3000);
  timeoutArray.push(temp);
  temp = setTimeout(() => clearTimeouts(), 5000);
  timeoutArray.push(temp);
};

const createChallengeFail = () => {
  const challengeFailSFX = PIXI.sound.Sound.from(sounds[1]);
  challengeFailSFX.play({ volume: 0.75 });

  const panelChallengeFail = new dxPanel(DX_PIXI, assetFail, DX_LAYERS.ui, "", {
    position: {
      x: DX_WIDTH / 2,
      y: DX_HEIGHT / 2,
    },
    scale: {
      x: 1,
      y: 1,
    },
    animationSpeed: 0.5,
  });
  let temp = setTimeout(() => panelChallengeFail.remove(), 3000);
  timeoutArray.push(temp);
  temp = setTimeout(() => clearTimeouts(), 5000);
  timeoutArray.push(temp);
};

//#endregion

//#region Skill functions

const init = () => {
  createTimer();
  setInitialSeal();
};

const createReminder = () => {
  reminder = new dxPanel(
    DX_PIXI,
    "ghostReminder",
    DX_LAYERS.ui,
    reminderTitle,
    {
      position: {
        x: DX_WIDTH / 2,
        y: 300,
      },
      scale: {
        x: 0.5,
        y: 0.5,
      },
      animationSpeed: 0.5,
    }
  );
};

const createTimer = () => {
  const interval = 1000;
  timer = new dxTimer(
    DX_PIXI,
    "newTime",
    DX_LAYERS.ui,
    challengeTime,
    interval,
    {
      position: {
        // x: (3 * DX_WIDTH) / 4 - 100,
        // y: 100,
        x: 200,
        y: DX_HEIGHT / 2 - 300,
      },
      scale: {
        x: 0.5,
        y: 0.5,
      },
      animationSpeed: 0.5,
    }
  );
};

const setInitialSeal = () => {
  //Make a random to select one seal
  let randomIdx = Math.floor(Math.random() * sealsNum.length);

  //Set the index of the first and the last element of the resources list.
  initialIdx = (sealsNum[randomIdx] - 1) * 4;
  lastIdx = initialIdx + 4;

  //Load the image
  symbol = new PIXI.Sprite.from(
    DX_PIXI.resources[images[initialIdx].name].texture
  );

  //Delete the index num from the seal list to don't repeat it again
  const index = sealsNum.indexOf(sealsNum[randomIdx]);
  console.log("radonmIdx", sealsNum[randomIdx], "idx", index);
  if (index > -1) {
    sealsNum.splice(index, 1);
  }
  console.log("Seals list", sealsNum);
  //Set the image parameters
  symbol.x = DX_WIDTH / 2;
  symbol.y = 300;
  symbol.anchor.set(0.5);
  symbol.zIndex = 90;
  symbol.scale = { x: 0.3, y: 0.3 };
  DX_LAYERS.ui.addChild(symbol);

  //Create an array with the correct seal and 2 incorrect options
  orderedAnswers.push(initialIdx);

  let prevSelection = -1;
  while (orderedAnswers.length != 3) {
    console.log("randomizing");
    randomIdx = getRandomNumBetween2Num(initialIdx + 1, lastIdx); //Increase the initial idx by one to avoid the correct option
    if (randomIdx != prevSelection) {
      orderedAnswers.push(randomIdx);
      prevSelection = randomIdx;
    }
  }
  console.log("orderedarray", orderedAnswers);

  //Unorder the options
  createRandomOrderAnswers();
  console.log("unorderedarray", unorderedAnswers);

  //Hide the seal
  let temp = setTimeout(() => hideInitialSeal(), 1000);
  timeoutArray.push(temp);
};

const hideInitialSeal = () => {
  symbol.destroy();
  showQuestion();
};

const showQuestion = () => {
  createReminder();
  createOptions();
};

const createOptions = () => {
  let count = 0;
  optionWidth = 216;
  let distanceBetweenOptions = 25;
  let totalWidth = optionWidth * 3 + distanceBetweenOptions * 2;
  unorderedAnswers.forEach((index) => {
    let button = new DxButton(images[index].name, "", {
      isClickable: true,
      controller: {
        isPressable: true,
        button: controllerButtonArray[count],
        x: 0,
        y: 300,
        scale: {
          x: 1,
          y: 1,
        },
      },
      keyboard: {
        isPressable: true,
        button: count + 1,
        x: 0,
        y: 300,
        scale: {
          x: 1,
          y: 1,
        },
      },
      position: {
        x:
          DX_WIDTH / 2 -
          totalWidth / 2 +
          count * (distanceBetweenOptions + optionWidth) +
          optionWidth / 2,
        y: DX_HEIGHT / 2,
      },
      scale: {
        x: 0.3,
        y: 0.3,
      },
      index: index,
    });

    button.start();
    buttonArray.push(button);
    button.onClick = (event) => {
      if (button._options.index === initialIdx) {
        //As we know that the initialIdx is the correct answer we compare the indexes
        console.log("TACHAN!");
        if (playedTimes != questionsNum) {
          resetGame();
          playedTimes++;
        } else {
          cleanAll();
          createChallengeSuccess();
        }
      } else {
        console.log("BOOOOOOOOOOH");
        cleanAll();
        createChallengeFail();
      }
    };
    count++;
  });
};

const resetGame = () => {
  cleanAll();
  setInitialSeal();
};

const cleanAll = () => {
  buttonArray.forEach((element) => {
    element.remove();
  });
  orderedAnswers = [];
  unorderedAnswers = [];
  reminder.remove();
};

const getRandomNumBetween2Num = (min = 5, max = 11) => {
  let diff = max - min;
  let rand = Math.floor(Math.random() * diff) + min;
  return rand;
};
const createRandomOrderAnswers = () => {
  unorderedAnswers = orderedAnswers
    .map((value) => ({ value, sort: Math.random() }))
    .sort((a, b) => a.sort - b.sort)
    .map(({ value }) => value);
};

//#endregion
