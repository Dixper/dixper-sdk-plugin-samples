const images = [
  //Seal 1
  {
    name: "correcto1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/1/correcto.png"
  },
  {
    name: "incorrecto1-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/1/incorrecto-1.png"
  },
  {
    name: "incorrecto1-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/1/incorrecto-2.png"
  },
  {
    name: "incorrecto1-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/1/incorrecto-3.png"
  },
  //Seal 2
  {
    name: "correcto2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/2/correcto.png"
  },
  {
    name: "incorrecto2-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/2/incorrecto-1.png"
  },
  {
    name: "incorrecto2-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/2/incorrecto-2.png"
  },
  {
    name: "incorrecto2-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/2/incorrecto-3.png"
  },
  //Seal 3
  {
    name: "correcto3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/3/correcto.png"
  },
  {
    name: "incorrecto3-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/3/incorrecto-1.png"
  },
  {
    name: "incorrecto3-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/3/incorrecto-2.png"
  },
  {
    name: "incorrecto3-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/3/incorrecto-3.png"
  },
  //Seal 4
  {
    name: "correcto4",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/4/correcto.png"
  },
  {
    name: "incorrecto4-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/4/incorrecto-1.png"
  },
  {
    name: "incorrecto4-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/4/incorrecto-2.png"
  },
  {
    name: "incorrecto4-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/4/incorrecto-3.png"
  },
  //Seal 5
  {
    name: "correcto5",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/5/correcto.png"
  },
  {
    name: "incorrecto5-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/5/incorrecto-1.png"
  },
  {
    name: "incorrecto5-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/5/incorrecto-2.png"
  },
  {
    name: "incorrecto5-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/5/incorrecto-3.png"
  },
  //Seal 6
  {
    name: "correcto6",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/6/correcto.png"
  },
  {
    name: "incorrecto6-1",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/6/incorrecto-1.png"
  },
  {
    name: "incorrecto6-2",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/6/incorrecto-2.png"
  },
  {
    name: "incorrecto6-3",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/6/incorrecto-3.png"
  },
];
const sprites = [
  {
    name: "ghostReminder",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/phasmophobia/src/phasmophobia/assets/spritesheets/phasmoReminder.json",
  },
  {
    name: "newTime",
    url: "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/phasmophobia/src/phasmophobia/assets/spritesheets/phasmoTimer.json",
  },
];
const sounds = [];

let reminder,
  timer,
  onClickSub,
  ghost,
  randomOrderGhost,
  selectedGhost,
  ghostName,
  evidencesGhost,
  randomEvidence,
  correctEvidence,
  correctAnswer,
  evidenceWrongAnswer,
  answers,
  randomAnswers,
  button;

let symbol;
let baseURL = "https://raw.githubusercontent.com/Dixper/dixper-sdk-plugin-samples/origin/phasmophobia-adri-skills/src/phasmophobia/assets/images/demon_seals/";
let sealsNum = [1, 2, 3, 4, 5, 6];
let initialIdx, lastIdx;

let orderedAnswers = [];
let unorderedAnswers = [];

// INPUTS PARAMS



const optionsList = [
  {
    option: "phasmoReminder.png",
  },
];

// DIXPER SDK INJECTED CLASS

const dixperPluginSample = new DixperSDKLib({
  pixi: {
    enable: true,
    files: [...images, ...sprites, ...sounds],
  },
});

// INPUTS

const { challengeTitle, challengeTime, reminderTitle } = DX_INPUTS;

// PIXIJS INITILIZE

dixperPluginSample.onPixiLoad = () => {
  dixperPluginSample.initChallenge(challengeTitle, challengeTime);
};

// INIT CHALLENGE

dixperPluginSample.onChallengeAccepted = () => {
  init();
};

dixperPluginSample.onChallengeRejected = () => {
  dixperPluginSample.stopSkill();
};

dixperPluginSample.onChallengeFinish = () => {
  console.log("onChallengeFinish");
  if (reminder) {
    reminder.remove();
  }
  dixperPluginSample.challengeFail();
  dixperPluginSample.stopSkill();
};
const init = () => {
  createTimer();
  generateQuestion();
};

const createReminder = () => {
  reminder = new dxPanel(
    DX_PIXI,
    "ghostReminder",
    DX_LAYERS.ui,
    reminderTitle,
    {
      position: {
        x: DX_WIDTH / 2,
        y: 300,
      },
      scale: {
        x: 0.5,
        y: 0.5,
      },
      animationSpeed: 0.5,
    }
  );
};

const createTimer = () => {
  const interval = 1000;
  timer = new dxTimer(
    DX_PIXI,
    "newTime",
    DX_LAYERS.ui,
    challengeTime,
    interval,
    {
      position: {
        // x: (3 * DX_WIDTH) / 4 - 100,
        // y: 100,
        x: 200,
        y: DX_HEIGHT / 2 - 300,
      },
      scale: {
        x: 0.5,
        y: 0.5,
      },
      animationSpeed: 0.5,
    }
  );
};

const generateQuestion = () => {
  setInitialSeal();
  // createGhostPanel(ghostName);
  // createRandomAnswers();
  // createAnswers();
  // createRandomOrderAnswers();
  // createButtonAnswer();
};

const setInitialSeal = () => {

  //Make a random to select one seal
  let randomIdx = Math.floor(Math.random() * sealsNum.length);

  //Set the index of the first and the last element of the resources list.
  initialIdx = randomIdx;
  lastIdx = initialIdx + 4;

  //Load the image
  symbol = new PIXI.Sprite.from(DX_PIXI.resources[(initialIdx - 1) * 4].texture);

  //Delete the index num from the list to don't repeat it again
  const index = sealsNum.indexOf(randomIdx);
  if (index > -1) {
    sealsNum.splice(index, 1);
  }

  console.log(randomIdx, sealsNum);

  //Set the image parameters
  symbol.x = DX_WIDTH / 2;
  symbol.y = 300;
  symbol.anchor.set(0.5);
  symbol.zIndex = 90;
  symbol.scale = { x: 0.5, y: 0.5 };

  DX_LAYERS.ui.addChild(symbol);

  //Create an array with the correct seal and 2 incorrect options
  orderedAnswers.push((initialIdx - 1) * 4);

  let prevSelection = -1;
  while (orderedAnswers.length != 3) {
    console.log("randomizing");
    randomIdx = getRandomNumBetween2Num(initialIdx + 1, lastIdx); //Increase the initial idx by one to avoid the correct option
    if (randomIdx != prevSelection) {
      orderedAnswers.push(randomIdx);
      prevSelection = randomIdx;
    }
  }
  console.log(orderedAnswers);

  //Hide the seal
  setTimeout(() => hideInitialSeal(), 3000);

};

const hideInitialSeal = () => {
  symbol.destroy();
  showQuestion();
}

const showQuestion = () => {
  createReminder();
  //createOptions();
}

const createOptions = () => {
  randomAnswers.forEach((element, index) => {
    position += 300;
    button = new DxButton("ghostPanel", "", {
      isClickable: true,
      controller: {
        isPressable: true,
        button: "FACE_1",
        x: 0,
        y: 40,
      },
      keyboard: {
        isPressable: true,
        button: `${index + 1}`,
        x: 0,
        y: 40,
      },
      position: {
        x: 150 + position,
        y: DX_HEIGHT / 2,
      },
      scale: {
        x: 0.5,
        y: 0.5,
      },
    });
    button.start();
    buttonsArray.push(button);
  });
  buttonsArray.forEach((button) => {
    checkCorrectAnswer(button);
  });
};

const createGhostPanel = (ghostName) => {
  ghost = new DxButton("ghostPanel", `${ghostName}`, {
    position: {
      x: DX_WIDTH / 2,
      y: DX_HEIGHT / 2 - 200,
    },
    scale: {
      x: 0.75,
      y: 0.75,
    },
  });
  ghost.start();
};



const createRandomAnswers = () => {
  evidencesGhost = selectedGhost.evidences;
  // console.log("evidences", evidencesGhost);
  randomEvidence = Math.floor(Math.random() * evidencesGhost.length);
  correctEvidence = evidencesGhost[randomEvidence];
  // console.log("correctEvidence", correctEvidence);

  evidencesList.forEach((e) => {
    if (e.evidence_id === correctEvidence) {
      correctAnswer = e;
    }
    return correctAnswer;
  });
  console.log("correctAnswer", correctAnswer.evidence);
  evidencesList.forEach((evidence) => {
    if (!evidence.ghosts.includes(selectedGhost.ghost_id)) {
      wrongAnswers.push(evidence.evidence);
    }
    return wrongAnswers;
  });
  // console.log("wrongAnswer", wrongAnswers);
};

const createAnswers = () => {
  for (let i = 0; i <= 1; i++) {
    let random = Math.floor(Math.random() * wrongAnswers.length);
    evidenceWrongAnswer = wrongAnswers.splice(random, 1);
    arrayWrongAnswer.push(...evidenceWrongAnswer);
  }
  answers = arrayWrongAnswer.concat(correctAnswer.evidence);
  // console.log("answers", answers);
};

const createRandomOrderAnswers = () => {
  randomAnswers = answers
    .map((value) => ({ value, sort: Math.random() }))
    .sort((a, b) => a.sort - b.sort)
    .map(({ value }) => value);
};

const checkCorrectAnswer = (button) => {
  button.onClick = () => {
    if (correctAnswer.evidence === button._text) {
      console.log("respuesta correcta");
      ghost.remove();
      buttonsArray.forEach((button) => {
        button.remove();
      });
      setTimeout(() => cleanAll(), 900);
      setTimeout(() => generateQuestion(), 1000);
    } else {
      console.log("respuesta incorrecta");
      ghost.remove();
      buttonsArray.forEach((button) => {
        button.remove();
      });
      setTimeout(() => cleanAll(), 900);
      setTimeout(() => generateQuestion(), 1000);
    }
  };
};

const cleanAll = () => {
  ghost = undefined;
  randomOrderGhost = undefined;
  selectedGhost = undefined;
  ghostName = undefined;
  evidencesGhost = undefined;
  randomEvidence = undefined;
  correctEvidence = undefined;
  correctAnswer = undefined;
  evidenceWrongAnswer = undefined;
  answers = undefined;
  randomAnswers = undefined;
  button = undefined;
  wrongAnswers = [];
  arrayWrongAnswer = [];
  buttonsArray = [];
  position = 200;
};

const getRandomNumBetween2Num = (min = 5, max = 11) => {
  let diff = max - min
  let rand = Math.floor(Math.random() * diff) + min;
  console.log("CLICKS TO BREAK: ", rand);
  return rand;
}